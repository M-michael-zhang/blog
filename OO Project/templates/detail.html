{% extends 'base.html' %}

{% block title %}Article{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static',filename= 'css/detail.css') }}">
{% endblock %}

{% block main %}
    <br>
    <div class="detail-container">
        <p class="subject"><span class="general_subject">General Subject...</span> / <span class="special_subject">Special Subject...</span>
        </p>
        <p class="score">score:there are too less data</p>
        <h3 class="title" style="text-align: center;">TITLE.....</h3>
        <p class="article-info">
            <span class="article-author" style="padding-right: 10px">Author:XXXX</span>
            <span class="article-time">Time:XXXX:XX:XX</span>
        </p>
        <hr>
        <label for="abstract" class="control-label">Abstract: </label>
        <p class="abstract">
            {#            1. Add a new comment to an article.
            2. Upvote this comment from IP address 1. Now the number of upvotes must be 1.
            3. Upvote this comment from IP address 2. Now the number of upvotes must be 2.#}
        </p>
        <hr>
        <a id="download" style="margin-left: 0px; font-size:16px" filename="">Click here to download the article!</a>
        <div class="vote-group">

            <button type="button" class="btn btn-default btn-sm btn_liked">
                <span class="glyphicon glyphicon-thumbs-up" aria-hidden="true"></span> <span class="liked">(0)</span>
            </button>
            <button type="button" class="btn btn-default btn-sm btn_disliked">
                <span class="glyphicon glyphicon-thumbs-down" aria-hidden="true"></span> <span
                    class="disliked">(0)</span>
        </div>
        <hr>
        <div class="myli"><br>
            <p> User Comment</p></div>
        <hr>
        <div class="comments">

            {#        <div class="comment_item">#}
            {#            <div class="comment_user">499887880@qq.com<span class="comment_time" style="float: right">2018.01.04 12:35</span><br></div>#}
            {#            <textarea class="comment_content" readonly="readonly" rows="3">asdasdasdasdd</textarea>#}
            {#        </div>#}
            {#<hr>#}

        </div>
        <hr>
        <div class="myli"><br>
            <p> Send Comment</p></div>

        <div class="form-group" style="margin-top: 20px;">
            <input type="text" id="send_content" class="form-control" placeholder="Please enter your comment...">
        </div>
        <div class="form-group" style="text-align: right">
            <button id="send_btn" class="btn btn-primary">Commit</button>
        </div>

    </div>
    <script>
        var article_id1 = localStorage.getItem("article_id");
        if (article_id1 == null) window.location.href = "{{ url_for('main') }}";
        var file_address;
        var subjectid;
        var liked = "";
        var disliked="";
        var gid;
        getComments();
        $.ajax({
            type: "GET",
            url: "http://127.0.0.1:5000/getArticlesById",
            data: {id: article_id1},
            success: function (data) {
                var myauthor = yc(data[0].author)
                subjectid = data[0].subject;
                $(".title").html(data[0].title);
                $(".article-author").html("Author:  " + myauthor)
                $(".article-time").html("Time:   " + data[0].time)
                $(".abstract").html(data[0].content)
                $("#download").attr("filename", data[0].filename)

                file_address = "http://127.0.0.1:5000/static/document/" + data[0].filename;

                $.ajax({
                    type: "GET",
                    url: "http://127.0.0.1:5000/getSubjectsById",
                    data: {sid: subjectid},
                    success: function (data) {
                        $(".special_subject").html(data[0].sname);
                        gid = data[0].generalSubject;
                        $.ajax({
                            type: "GET",
                            url: "http://127.0.0.1:5000/getGeneralSubjectById",
                            data: {gid: gid},
                            success: function (data) {
                                $(".general_subject").html(data[0].name);

                            },
                            error: function (e) {

                            }

                        });
                    },
                    error: function (e) {

                    }

                });
            },
            error: function (e) {

            }

        });

        updateliked();
        updatedisliked();

        $("#download").click(function () {
            window.location.href = file_address
        });


        function inputusername() {
            var x;
            var person = prompt("Please enter your email", "XXXX@163.com");
            if (validmailaddress(person) == 1) {
                return person;
            } else {
                return inputusername();
            }
        }

        $(".btn_liked").click(function () {
            var user = inputusername();
            $.ajax({
                type: "GET",
                url: "http://127.0.0.1:5000/getIsLiked",
                data: {aid: article_id1, reader: user},
                success: function (data) {
                    if (data == 1) {
                        alert("you had liked this article before");
                    }
                    else {
                        addliked(user);


                    }
                },
                error: function (e) {
                }
            });
        })
        $(".btn_disliked").click(function () {
            var user = inputusername();
            $.ajax({
                type: "GET",
                url: "http://127.0.0.1:5000/getIsDisliked",
                data: {aid: article_id1, reader: user},
                success: function (data) {
                    if (data == 1) {
                        alert("you had disliked this article before");
                    }
                    else {
                        adddisliked(user);


                    }
                },
                error: function (e) {
                }
            });
        })

        function getComments() {
            $.ajax({
                type: "GET",
                url: "http://127.0.0.1:5000/getCommentByArticle",
                data: {aid: article_id1},
                success: function (data) {
                    $(".comments").html("");
                    if (data != "") {
                        for (var i = data.length-1; i >=0 ; i--) {
                            $(".comments").append("  <div class=\"comment_item\">\n" +
                                "            <div class=\"comment_user\">" + data[i].reader + "<span class=\"comment_time\" style=\"float: right\">" + data[i].time + "</span><br></div>\n" +
                                "            <div class=\"comment_content\" readonly=\"readonly\" rows=\"3\">" + data[i].content + "</div>\n" +
                                "        </div>\n" +
                                "<hr>\n" +
                                "      ")
                        }

                    }
                    else {
                        $(".comments").append("there are no comments")
                    }
                },
                error: function (e) {
                }
            });
        }

        function addliked(user1) {
            $.ajax({
                type: "GET",
                url: "http://127.0.0.1:5000/addLiked",
                data: {aid: article_id1, reader: user1},
                success: function (data) {
                    updateliked();
                },
                error: function (e) {
                }
            });

        }

        function adddisliked(user1) {
            $.ajax({
                type: "GET",
                url: "http://127.0.0.1:5000/addDisliked",
                data: {aid: article_id1, reader: user1},
                success: function (data) {
                    updatedisliked();
                },
                error: function (e) {
                }
            });

        }

        function updateliked() {
            $.ajax({
                type: "GET",
                url: "http://127.0.0.1:5000/getCountLikedByAid",
                data: {aid: article_id1},
                success: function (data) {
                    $(".liked").html("(" + data + ")")
                    liked=parseInt(data);
                    if(disliked!=""){
                         if(disliked==0||liked==0){
                            $(".score").html("there are too less data")
                        }
                        else {
                            $(".score").html("score:"+parseInt(liked/(liked+disliked)*100)+"%")
                        }
                    }
                },
                error: function (e) {
                }
            });
        }

        function updatedisliked() {
            $.ajax({
                type: "GET",
                url: "http://127.0.0.1:5000/getCountDislikedByAid",
                data: {aid: article_id1},
                success: function (data) {
                    $(".disliked").html("(" + data + ")")
                    disliked=parseInt(data);
                    if(liked!=""){
                        if(disliked==0||liked==0){
                            $(".score").html("there are too less data")
                        }
                        else {
                            $(".score").html("score:"+parseInt(liked/(liked+disliked)*100)+"%")
                        }

                    }
                },
                error: function (e) {
                }
            });
        }

        $("#send_btn").click(function () {


            var cont = $("#send_content").val();
            var user = inputusername();
            if (valid_clear(cont) && judge_short_time()) {
                $.ajax({
                    type: "GET",
                    url: "http://127.0.0.1:5000/addComment",
                    data: {aid: article_id1, reader: user, content: cont},
                    success: function (data) {
                        alert(data);
                        getComments();
                        localStorage.setItem("commentTime", new Date().toString());
                    },
                    error: function (e) {
                    }
                });
            }

        })


        function validmailaddress(str) {
            var filter = /^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;
            if (filter.test(str)) return true;
            else {
                alert('Your email format is not correct! \n');
                return false;
            }
        }

        function yc(phone) {
            var myphone = phone.split('@');
            var number = myphone[0];
            length = number.length;
            number = number.substring(0, length / 2);
            var s = "";
            for (var i = 0; i < length / 2; i++) {
                s += "*";
            }
            number = number + s + '@' + myphone[1];
            return number;
        }

        localStorage.setItem("commentTime", "");

        function judge_short_time() {
            var myDate = new Date();
            var time = localStorage.getItem("commentTime");
            if (time == "") {
                return 1;
            }
            else {
                lastdate = new Date(time);

                if (myDate - lastdate > 10000) {
                    return 1;

                }
                else {
                    alert("can't submit in a short time")
                    return 0;
                }
            }
        }
    </script>

{% endblock %}
