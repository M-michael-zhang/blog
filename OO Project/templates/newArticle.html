{% extends 'base.html' %}

{% block title %}NewArticle{% endblock %}
{% block head %}
    <link rel="stylesheet" href="{{ url_for('static',filename= 'css/newArticle.css') }}">
{% endblock %}

{% block main %}
    <h3 class="page-tittle">Welcome to Publish Your Article!</h3>
    <br>
    <div action="" class="form-horizontal" method=post">
        <div class="form-container">
            <div class="form-group" style="margin-left: 5%">
                <label for="general-subject">General Subject: </label>
                <select class="form-control" id="gselected" style="width: 80%">
                    <option class="gs" gid="1">Physical Sciences</option>
                    <option class="gs" gid="2">Social Sciences</option>
                    <option class="gs" gid="3">Biological Sciences</option>
                    <option class="gs" gid="4">Computer Sciences</option>
                    <option  class="gs" gid="5">Statistics</option>
                    <option class="gs" gid="6">Mathematics</option>
                    <option class="gs" gid="7">Medical Sciences</option>
                </select>
    </div>

    <div class="form-group" style="margin-left: 5%">
                <label for="general-subject">Special Subject: </label>
                <select class="form-control" id="sselected" style="width: 80%">
                    <option>please choose a general subject</option>
                </select>
    </div>
            <div class="form-group">
                <label for="tittle" class="control-label">Tittle: </label>
                <input id="title" type="text" placeholder="Enter the Tittle" name="tittle" class="form-control">
            </div>
            <div class="form-group">
                <label for="abstract" class="control-label">Abstract: </label>
                <textarea id="content" name="abstract" rows="5" placeholder="An Abstract..." class="form-control"></textarea>
            </div>
            <div class="form-group">
                <label for="email" class="control-label">Email: </label>
                <input id="author" type="text" placeholder="Enter Your Email" name="tittle" class="form-control">
            </div>
            <div class="form-group">
                <form id="myf" style="float: left;width: 150px">
        <input type="file" name="articlePDF" id="InputFile" onchange="Javascript:validate_file(this);" accept=".pdf" />
             <input type="text" value="1" name="index" id="index" style="display: none"/>
            <p class="help-block">please choose a PDF file.</p>
        </form>
                <button class="btn1 btn btn-primary" >upload the file</button>
                <button class="btn btn-primary  btn-lg active btn2" type="submit" style="float:right">PUBLISH NOW</button>
            </div>
        </div>
    </div>
<script>
 var gid;
    var sid;
    var filename="";
    gid=$("option:selected","#gselected").attr("gid");
    $.ajax({
             type: "GET",
             url: "http://127.0.0.1:5000/getSubjectsByGS",
           data:{gsid:gid},
             success: function(data){
                        $("#sselected").html("")
                        for(var i=0;i<data.length;i++){
                            $("#sselected").append("<option sid=\""+data[i].sid+"\">"+data[i].sname+"</option>")
                        }
                        flag=1;
                      },
            error: function (e) {

            }
         });
    sid=$("option:selected","#sselected").attr("sid");
    $("#gselected").on("change",function(){
        gid=$("option:selected",this).attr("gid");
       $.ajax({
             type: "GET",
             url: "http://127.0.0.1:5000/getSubjectsByGS",
           data:{gsid:gid},
             success: function(data){
                        $("#sselected").html("")
                        for(var i=0;i<data.length;i++){
                            $("#sselected").append("<option sid=\""+data[i].sid+"\">"+data[i].sname+"</option>")
                        }
                        flag=1;
                      },
            error: function (e) {

            }

         });
          sid=$("option:selected","#sselected").attr("sid");
    });

    $("#sselected").on("change",function(){
         sid=$("option:selected",this).attr("sid");

    });
$(".btn1").click(function () {
    var formData = new FormData($('#myf')[0]);
    $.ajax({
        type: "post",
        url: "http://127.0.0.1:5000/upload",
        data: formData,
        processData: false,
        contentType: false,
        success: function (data) {
            filename=data;
            alert("Upload Successfully! ")
        },
        error: function (e) {

        }

    });
})
$(".btn2").click(function () {
    var title = $("#title").val();
    var content= $("#content").val();
    var author = $("#author").val();
    if(validmailaddress(author)&&validIsEmpty(title)&&validIsEmpty(content)&&validIsEmpty(filename)&&valid_clear(content)&&valid_clear(title)&&judge_short_time()){
          $.ajax({
             type: "GET",
             url: "http://127.0.0.1:5000/addArticles",
            data:{subject:sid,title:title,content:content,author:author,filename:filename},
             success: function(data){
                        alert(data);
                        localStorage.setItem("articleTime",new Date().toString());
                      },
            error: function (e) {

            }

         });
    }


})

function validmailaddress(str){
    var filter = /^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;
if (filter.test(str)) return true;
else {
alert('Your email format is not correct! \n');
return false;}
}
function validIsEmpty(str) {
    if(str==""){
        alert("Something is empty");
        return false;
    }
    else return true;
    
}
 function validate_file(ele){
        if(((ele.files[0].size).toFixed(2))>=(20*1024*1024)){

          alert("请上传小于20M文件");

      }
 }
  localStorage.setItem("articleTime","");

 function judge_short_time() {
     var myDate = new Date();
     var time = localStorage.getItem("articleTime");
     if(time!=""){
         lastdate = new Date(time);
         if(myDate-lastdate>60000){
             return 1;
         }
                else{
                    alert("can't submit in a short time")
                    return 0;
                }
            }
            else{
                return 1;
     }

        }
</script>
{% endblock %}
